{% extends "base.html" %}

{% block title %}Select Server - WISP{% endblock %}

{% block content %}
<div class="server-select-container">
    <div class="server-select-header">
        <h1>Select a Server</h1>
        <p>Choose a server to manage with WISP</p>
    </div>
    
    <div class="server-grid" id="serverGrid">
        <!-- Servers will be loaded here -->
        <div class="loading">
            <p>Loading servers...</p>
            <div class="spinner"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const serverGrid = document.getElementById('serverGrid');
        
        // Try to get guilds from our API
        let servers = [];
        
        try {
            const response = await fetch('/api/guilds');
            if (response.ok) {
                servers = await response.json();
                console.log('Server data loaded:', servers.length, 'servers');
            } else {
                console.error('Failed to fetch guilds:', response.status);
                serverGrid.innerHTML = '<div class="error-message">Error loading servers. Please try refreshing the page.</div>';
                return;
            }
        } catch (error) {
            console.error('Error fetching guilds:', error);
            serverGrid.innerHTML = '<div class="error-message">Error loading servers. Please try refreshing the page.</div>';
            return;
        }
        
        // Clear loading indication
        serverGrid.innerHTML = '';
        
        if (servers.length === 0) {
            serverGrid.innerHTML = '<div class="error-message">No available servers found. Make sure the bot is added to your servers.</div>';
            return;
        }
        
        // Sort servers by name
        servers.sort((a, b) => {
            const nameA = a.name ? a.name.toLowerCase() : 'unknown';
            const nameB = b.name ? b.name.toLowerCase() : 'unknown';
            return nameA.localeCompare(nameB);
        });
        
        servers.forEach(server => {
            const serverCard = document.createElement('div');
            serverCard.className = 'server-card';
            
            // Use default icon placeholder if no icon
            let serverIconHtml = '';
            if (server.icon) {
                console.log(`Server ${server.name} has icon: ${server.icon}`);
                const iconUrl = `https://cdn.discordapp.com/icons/${server.id}/${server.icon}.png`;
                serverIconHtml = `<img src="${iconUrl}" alt="${server.name}" onerror="console.error('Failed to load icon for ${server.name}'); this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
            }
            
            const nameInitial = server.name ? server.name.charAt(0).toUpperCase() : '?';
            
            serverCard.innerHTML = `
                <div class="server-icon">
                    ${serverIconHtml}
                    <div class="server-icon-placeholder" ${server.icon ? 'style="display:none;"' : ''}>${nameInitial}</div>
                </div>
                <div class="server-info">
                    <h3>${server.name || 'Unknown Server'}</h3>
                    <p>${server.member_count > 0 ? `${server.member_count} members` : ''}</p>
                </div>
            `;
            
            serverCard.addEventListener('click', () => {
                window.location.href = `/dashboard?guild_id=${server.id}`;
            });
            
            serverGrid.appendChild(serverCard);
        });
    } catch (error) {
        console.error('Error loading servers:', error);
        document.getElementById('serverGrid').innerHTML = '<div class="error-message">Error loading servers. Please try again later.</div>';
    }
});
</script>

<style>
.loading {
    text-align: center;
    padding: 30px;
    color: #7289da;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(114, 137, 218, 0.2);
    border-radius: 50%;
    border-top-color: #7289da;
    animation: spin 1s ease-in-out infinite;
    margin: 10px auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    text-align: center;
    padding: 20px;
    color: #f04747;
    background-color: rgba(240, 71, 71, 0.1);
    border-radius: 8px;
    margin: 20px 0;
}

.server-icon-placeholder {
    background: linear-gradient(135deg, #7b68ee, #9370db);
    color: white;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}
</style>
{% endblock %} 