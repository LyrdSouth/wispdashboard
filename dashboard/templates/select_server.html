{% extends "base.html" %}

{% block title %}Select Server - WISP{% endblock %}

{% block content %}
<div class="server-select-container">
    <div class="server-select-header">
        <h1>Select a Server</h1>
        <p>Choose a server to manage with WISP</p>
    </div>
    
    <div class="server-grid" id="serverGrid">
        <!-- Servers will be loaded here -->
        <div class="loading">
            <p>Loading servers...</p>
            <div class="spinner"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Bot API details - used as fallback if Discord API fails
const BOT_API_URL = "http://45.90.13.151:6150/api";
const BOT_TOKEN = "{{ bot_token }}";

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const serverGrid = document.getElementById('serverGrid');
        
        // Try to get guilds from our API first
        let servers = [];
        let discordServers = [];
        
        try {
            const response = await fetch('/api/guilds');
            if (response.ok) {
                discordServers = await response.json();
                console.log('Discord servers:', discordServers);
            } else {
                console.error('Failed to fetch guilds from Discord API:', response.status);
            }
        } catch (discordError) {
            console.error('Error fetching from Discord API:', discordError);
        }
        
        // If Discord API call failed or returned empty, try direct bot API
        if (!discordServers.length) {
            try {
                console.log('Trying direct bot API...');
                const directResponse = await fetch('/api/bot-guilds');
                if (directResponse.ok) {
                    const botServers = await directResponse.json();
                    console.log('Bot servers:', botServers);
                    servers = botServers;
                } else {
                    console.error('Failed to fetch bot guilds:', directResponse.status);
                }
            } catch (botError) {
                console.error('Error fetching from bot API:', botError);
            }
        } else {
            servers = discordServers;
        }
        
        // Clear loading indication
        serverGrid.innerHTML = '';
        
        if (servers.length === 0) {
            serverGrid.innerHTML = '<div class="error-message">No available servers found. Make sure the bot is added to your servers.</div>';
            return;
        }
        
        servers.forEach(server => {
            const serverCard = document.createElement('div');
            serverCard.className = 'server-card';
            
            // Use default icon placeholder if no icon
            const serverIcon = server.icon 
                ? `<img src="https://cdn.discordapp.com/icons/${server.id}/${server.icon}.png" alt="${server.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                : '';
            
            serverCard.innerHTML = `
                <div class="server-icon">
                    ${serverIcon}
                    <div class="server-icon-placeholder" ${server.icon ? 'style="display:none;"' : ''}>${server.name.charAt(0).toUpperCase()}</div>
                </div>
                <div class="server-info">
                    <h3>${server.name}</h3>
                    <p>${server.member_count || ''} members</p>
                </div>
            `;
            
            serverCard.addEventListener('click', () => {
                window.location.href = `/dashboard?guild_id=${server.id}`;
            });
            
            serverGrid.appendChild(serverCard);
        });
    } catch (error) {
        console.error('Error loading servers:', error);
        document.getElementById('serverGrid').innerHTML = '<div class="error-message">Error loading servers. Please try again later.</div>';
    }
});
</script>

<style>
.loading {
    text-align: center;
    padding: 30px;
    color: #7289da;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(114, 137, 218, 0.2);
    border-radius: 50%;
    border-top-color: #7289da;
    animation: spin 1s ease-in-out infinite;
    margin: 10px auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    text-align: center;
    padding: 20px;
    color: #f04747;
    background-color: rgba(240, 71, 71, 0.1);
    border-radius: 8px;
    margin: 20px 0;
}

.server-icon-placeholder {
    background: linear-gradient(135deg, #7b68ee, #9370db);
    color: white;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}
</style>
{% endblock %} 