{% extends "base.html" %}

{% block title %}Dashboard - {{ guild_name }}{% endblock %}

{% block head %}
<style>
.server-icon-container {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    overflow: hidden;
    background-color: #2f3136;
    display: flex;
    align-items: center;
    justify-content: center;
}

.server-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
}

.server-icon-placeholder {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7b68ee, #9370db);
    color: white;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Dashboard</h1>
    <div class="server-info">
        <div class="server-icon" id="server-icon-container">
            <img id="server-icon" src="{{ guild_icon_url }}" alt="{{ guild_name }}" class="server-icon" onerror="this.style.display='none'; createInitialsIcon('{{ guild_name }}');">
            <div id="server-initials" class="server-icon-placeholder" style="display:none;"></div>
        </div>
        <h2 id="server-name">{{ guild_name }}</h2>
    </div>
</div>

<div class="dashboard-content">
    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <div class="stat-info">
                <span class="stat-value" id="member-count">{{ settings.member_count|default('-', true) }}</span>
                <span class="stat-label">Members</span>
            </div>
        </div>
        <div class="stat-card">
            <i class="fas fa-terminal"></i>
            <div class="stat-info">
                <span class="stat-value" id="command-count">{{ settings.command_count|default('-', true) }}</span>
                <span class="stat-label">Commands Used</span>
            </div>
        </div>
        <div class="stat-card">
            <i class="fas fa-shield-alt"></i>
            <div class="stat-info">
                <span class="stat-value" id="mod-actions">{{ settings.mod_actions|default('-', true) }}</span>
                <span class="stat-label">Mod Actions</span>
            </div>
        </div>
    </div>

    <!-- Server Settings -->
    <div class="settings-section">
        <h2>Server Settings</h2>
        <div class="settings-grid">
            <!-- Command Prefix -->
            <div class="setting-card">
                <h3>Command Prefix</h3>
                <form id="prefix-form" class="setting-form">
                    <div class="form-group">
                        <input type="text" id="prefix" name="prefix" maxlength="3" value="{{ settings.prefix|default('?', true) }}" placeholder="Enter prefix (max 3 chars)">
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            </div>

            <!-- Features/Cogs -->
            <div class="setting-card">
                <h3>Enabled Features</h3>
                <form id="cogs-form" class="setting-form">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="cogs" value="image" {% if 'image' in settings.cogs|default([], true) %}checked{% endif %}> Image Commands
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="cogs" value="security" {% if 'security' in settings.cogs|default([], true) %}checked{% endif %}> Security Features
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Features</button>
                    </div>
                </form>
            </div>

            <!-- Log Channel -->
            <div class="setting-card">
                <h3>Log Channel</h3>
                <form id="log-channel-form" class="setting-form">
                    <div class="form-group">
                        <select id="log-channel" name="channel">
                            <option value="">Select a channel</option>
                            <!-- Channels will be loaded via JavaScript -->
                        </select>
                        <button type="submit" class="btn btn-primary">Save Channel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notification-container"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Font Awesome from public CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script>
// Function to create initials icon as fallback
function createInitialsIcon(serverName) {
    console.log("Creating initials icon for:", serverName);
    const initialsElement = document.getElementById('server-initials');
    if (initialsElement) {
        // Get first letter of server name or use '?' if empty
        const initial = serverName ? serverName.charAt(0).toUpperCase() : '?';
        initialsElement.textContent = initial;
        initialsElement.style.display = 'flex';
        console.log("Set initial to:", initial);
    } else {
        console.error("Could not find server-initials element");
    }
}

// Get parameters from server-side
const guildId = "{{ guild_id }}";
let serverSettings = {{ settings|tojson|safe }};

// Load all necessary data when page loads
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Add notification container if it doesn't exist
        if (!document.getElementById('notification-container')) {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '1000';
            document.body.appendChild(container);
        }

        // First, fetch the latest guild data to ensure we have current information
        await refreshGuildData();
        
        // Then load channels
        await loadChannels();
        
        // Set log channel if it exists (needs to be after channels are loaded)
        const logChannelId = serverSettings.log_channel;
        if (logChannelId) {
            const logChannelSelect = document.getElementById('log-channel');
            setTimeout(() => {
                logChannelSelect.value = logChannelId;
            }, 500); // Small delay to ensure channels are loaded
        }

        // Set up form submission handlers
        document.getElementById('prefix-form').addEventListener('submit', updatePrefix);
        document.getElementById('cogs-form').addEventListener('submit', updateCogs);
        document.getElementById('log-channel-form').addEventListener('submit', updateLogChannel);
        
        // Show success message after loading
        showNotification('Dashboard loaded successfully', 'success');
    } catch (error) {
        console.error('Error initializing dashboard:', error);
        showNotification('Error initializing dashboard: ' + error.message, 'error');
    }
});

// Refresh guild data
async function refreshGuildData() {
    try {
        const response = await fetch(`/api/guild/${guildId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch guild data: ${response.status}`);
        }
        
        const serverData = await response.json();
        console.log('Received guild data:', serverData);
        
        // Update server settings in memory
        serverSettings = serverData.settings || {};
        
        // Update page elements with server data
        document.getElementById('server-name').textContent = serverData.name || 'Unknown Server';
        document.getElementById('prefix').value = serverSettings.prefix || '?';
        
        // Update server icon with better error handling
        const serverIcon = document.getElementById('server-icon');
        if (serverData.icon) {
            console.log("Server has icon:", serverData.icon);
            const iconUrl = `https://cdn.discordapp.com/icons/${guildId}/${serverData.icon}.png`;
            console.log("Setting icon URL:", iconUrl);
            serverIcon.src = iconUrl;
            serverIcon.onerror = function() {
                console.error("Icon failed to load:", this.src);
                this.style.display = 'none';
                createInitialsIcon(serverData.name || 'Unknown Server');
            };
            serverIcon.onload = function() {
                console.log("Icon loaded successfully");
            };
        } else {
            console.log("Server has no icon, using initials");
            serverIcon.style.display = 'none';
            createInitialsIcon(serverData.name || 'Unknown Server');
        }
        
        // Update stats with better fallbacks
        console.log("Member count data:", serverData.member_count, typeof serverData.member_count);
        if (serverData.member_count !== undefined) {
            document.getElementById('member-count').textContent = serverData.member_count;
        } else {
            document.getElementById('member-count').textContent = 'N/A';
        }
        document.getElementById('command-count').textContent = serverSettings.command_count || 0;
        document.getElementById('mod-actions').textContent = serverSettings.mod_actions || 0;
        
        // Update checkboxes
        const cogs = serverSettings.cogs || [];
        document.querySelectorAll('input[name="cogs"]').forEach(checkbox => {
            checkbox.checked = cogs.includes(checkbox.value);
        });
        
        return serverData;
    } catch (error) {
        console.error('Error refreshing guild data:', error);
        showNotification('Failed to load server data: ' + error.message, 'error');
        throw error;
    }
}

// Load server channels
async function loadChannels() {
    try {
        const response = await fetch(`/api/guild/${guildId}/channels`);
        if (!response.ok) {
            throw new Error(`Failed to fetch channels: ${response.status}`);
        }
        
        const channels = await response.json();
        
        // Verify channels is an array
        if (!Array.isArray(channels)) {
            console.error('Channels data is not an array:', channels);
            throw new Error('Invalid channel data format');
        }
        
        // Sort channels by position
        const sortedChannels = [...channels].sort((a, b) => a.position - b.position);
        
        // Populate channel dropdown
        const channelSelect = document.getElementById('log-channel');
        channelSelect.innerHTML = '<option value="">Select a channel</option>';
        
        sortedChannels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = '#' + channel.name;
            channelSelect.appendChild(option);
        });
        
        // Set the selected channel if it exists in settings
        if (serverSettings.log_channel) {
            channelSelect.value = serverSettings.log_channel;
        }
        
        return channels;
    } catch (error) {
        console.error('Error loading channels:', error);
        showNotification('Failed to load channels: ' + error.message, 'error');
        
        // Clear dropdown with just the default option
        const channelSelect = document.getElementById('log-channel');
        channelSelect.innerHTML = '<option value="">No channels available</option>';
        return [];
    }
}

// Update prefix
async function updatePrefix(event) {
    event.preventDefault();
    const prefix = document.getElementById('prefix').value;
    
    try {
        const response = await fetch(`/api/guild/${guildId}/prefix`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prefix })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update prefix');
        }
        
        const result = await response.json();
        showNotification(`Prefix updated to: ${prefix}`, 'success');
        serverSettings.prefix = prefix;
    } catch (error) {
        console.error('Error updating prefix:', error);
        showNotification('Failed to update prefix: ' + error.message, 'error');
    }
}

// Update cogs/features
async function updateCogs(event) {
    event.preventDefault();
    
    const checkboxes = document.querySelectorAll('input[name="cogs"]:checked');
    const cogs = Array.from(checkboxes).map(cb => cb.value);
    
    try {
        const response = await fetch(`/api/guild/${guildId}/cogs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cogs })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update features');
        }
        
        const result = await response.json();
        showNotification('Enabled features updated', 'success');
        serverSettings.cogs = cogs;
    } catch (error) {
        console.error('Error updating cogs:', error);
        showNotification('Failed to update features: ' + error.message, 'error');
    }
}

// Update log channel
async function updateLogChannel(event) {
    event.preventDefault();
    
    const channelId = document.getElementById('log-channel').value;
    
    try {
        const response = await fetch(`/api/guild/${guildId}/log-channel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ channel_id: channelId })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update log channel');
        }
        
        const result = await response.json();
        showNotification('Log channel updated', 'success');
        serverSettings.log_channel = channelId;
    } catch (error) {
        console.error('Error updating log channel:', error);
        showNotification('Failed to update log channel: ' + error.message, 'error');
    }
}

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    const container = document.getElementById('notification-container');
    container.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}

// Add styles for notifications if not already in dashboard.css
const notificationStyles = `
.notification {
    padding: 12px 16px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    color: white;
    max-width: 300px;
    transition: opacity 0.5s ease;
}
.notification.success {
    background-color: #4CAF50;
}
.notification.error {
    background-color: #F44336;
}
.notification.info {
    background-color: #2196F3;
}
.notification.fade-out {
    opacity: 0;
}
`;

// Add the styles if not already present
if (!document.getElementById('notification-styles')) {
    const styleEl = document.createElement('style');
    styleEl.id = 'notification-styles';
    styleEl.textContent = notificationStyles;
    document.head.appendChild(styleEl);
}
</script>
{% endblock %} 